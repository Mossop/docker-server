#! /bin/sh

TARGET=/rhodecode/services/community

mkdir -p ${TARGET}
ln -s /rhodecode/cache/community ${TARGET}/profile

mkdir ${TARGET}/custom_modules
mkdir ${TARGET}/data
ln -s ${TARGET}/profile/lib/python2.7/site-packages/rhodecode/public ${TARGET}/public
ln -s ${TARGET}/profile/lib/python2.7/site-packages/rhodecode/public ${TARGET}/static
cp /rhodecode/profile/lib/python2.7/site-packages/rccontrol/lib/configs/rhodecode400_mapping.ini.tmpl ${TARGET}/search_mapping.ini

cp ${TARGET}/profile/etc/production.ini ${TARGET}/rhodecode.ini
change-ini-value ${TARGET}/rhodecode.ini "host" "0.0.0.0"
change-ini-value ${TARGET}/rhodecode.ini "port" "80"
change-ini-value ${TARGET}/rhodecode.ini "proc_name" "rhodecode_community"
change-ini-value ${TARGET}/rhodecode.ini "#archive_cache_dir" "${TARGET}/tarballcache"
change-ini-value ${TARGET}/rhodecode.ini "app_instance_uuid" `cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 32 | head -n 1`
change-ini-value ${TARGET}/rhodecode.ini "license_token" "9bad-a9cc-080e-11ea"
change-ini-value ${TARGET}/rhodecode.ini "beaker.session.key" "community"
change-ini-value ${TARGET}/rhodecode.ini "beaker.session.secret" `cat /dev/urandom | tr -dc 'a-z0-9' | fold -w 32 | head -n 1`
change-ini-value ${TARGET}/rhodecode.ini "sqlalchemy.db1.url" "${RC_DATABASE}"
change-ini-value ${TARGET}/rhodecode.ini "vcs.server" "127.0.0.1:9900"
change-ini-value ${TARGET}/rhodecode.ini "workers" "4"
change-ini-value ${TARGET}/rhodecode.ini "instance_id" "*"
change-ini-value ${TARGET}/rhodecode.ini "worker_class" "gevent"
change-ini-value ${TARGET}/rhodecode.ini "ssh.wrapper_cmd" "${TARGET}/profile/bin/rc-ssh-wrapper"
change-ini-value ${TARGET}/rhodecode.ini "ssh.generate_authorized_keyfile" "true"
change-ini-value ${TARGET}/rhodecode.ini "ssh.executable.hg" "/rhodecode/services/vcsserver/profile/bin/hg"
change-ini-value ${TARGET}/rhodecode.ini "ssh.executable.git" "/rhodecode/services/vcsserver/profile/bin/git"
change-ini-value ${TARGET}/rhodecode.ini "ssh.executable.svn" "/rhodecode/services/vcsserver/profile/bin/svnserve"
change-ini-value ${TARGET}/rhodecode.ini "ssh.authorized_keys_file_path" "/rhodecode/services/ssh/authorized_keys"
cp /rhodecode/profile/lib/python2.7/site-packages/rccontrol/lib/configs/gunicorn_config.py.tmpl ${TARGET}/gunicorn_config.py

cd $TARGET
./profile/bin/rc-setup-app \
  --force-yes \
  --user ${RC_ADMIN_USERNAME} \
  --email ${RC_ADMIN_EMAIL} \
  --password ${RC_ADMIN_PASSWORD} \
  --repos /rhodecode/repos \
  rhodecode.ini

echo ${COMMUNITY_VERSION} > ${TARGET}/.version
